{% extends "./master/layout.html" %}

{% block title %}
  Create ZIP Archive - Compactify
{% endblock %}

{% block head %}
  {{ super() }}
{% endblock %}

{% block content %}
<script>
function zipFileManager() {
  return {
    files: [],
    isDragOver: false,
    isProcessing: false,
    errorMessage: '',

    addFile() {
      this.files.push({
        id: Date.now() + Math.random(),
        file: null,
        name: '',
        size: 0
      });
    },

    removeFile(index) {
      this.files.splice(index, 1);
    },

    handleFileSelect(event, index) {
      const file = event.target.files[0];
      if (file) {
        this.files[index].file = file;
        this.files[index].name = file.name;
        this.files[index].size = file.size;
      }
    },

    handleDrop(event) {
      this.isDragOver = false;
      const droppedFiles = Array.from(event.dataTransfer.files);
      
      droppedFiles.forEach(file => {
        this.files.push({
          id: Date.now() + Math.random(),
          file: file,
          name: file.name,
          size: file.size
        });
      });
    },

    formatFileSize(bytes) {
      if (!bytes) return '';
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(1024));
      return Math.round(bytes / Math.pow(1024, i) * 100) / 100 + ' ' + sizes[i];
    },

    handleSubmit(event) {
      const validFiles = this.files.filter(item => item.file !== null);
      if (validFiles.length === 0) {
        event.preventDefault();
        this.errorMessage = 'Please select at least one file to create ZIP archive';
        return;
      }
      this.isProcessing = true;
    },

    getTotalSize() {
      return this.files.reduce((total, item) => total + (item.size || 0), 0);
    },

    getValidFileCount() {
      return this.files.filter(item => item.file !== null).length;
    }
  }
}
</script>

<!-- Background with gradient -->
<div class="min-h-screen py-8 bg-gradient-to-br from-yellow-50 via-white to-orange-50">
  <div class="container px-4 mx-auto">
    <!-- Main Card -->
    <div class="max-w-4xl mx-auto">
      <div class="overflow-hidden bg-white border border-gray-100 shadow-2xl rounded-3xl">
        <!-- Header Section -->
        <div class="px-8 py-12 text-center bg-gradient-to-r from-yellow-500 to-orange-600">
          <div class="flex justify-center mb-6">
            <div class="p-4 rounded-full bg-white/20 backdrop-blur-sm">
              <img src="{{ url_for('static', filename='image/logo.png') }}" class="w-auto h-16" alt="Compactify Logo" />
            </div>
          </div>
          <h1 class="mb-2 text-3xl font-bold text-white">Create ZIP Archive</h1>
          <p class="text-yellow-100">Compress multiple files into a single ZIP archive</p>
        </div>
        
        <!-- Form Section -->
        <div class="p-8">
          <form x-data="zipFileManager()" @submit="handleSubmit($event)" action="{{ url_for('zip') }}" method="POST" enctype="multipart/form-data">
            
            <!-- Drop Zone -->
            <div class="mb-8">
              <div 
                class="relative p-8 text-center transition-all duration-200 border-2 border-yellow-300 border-dashed rounded-2xl hover:border-yellow-400 hover:bg-yellow-50/50"
                :class="{ 'border-yellow-500 bg-yellow-50': isDragOver }"
                @dragover.prevent="isDragOver = true"
                @dragleave.prevent="isDragOver = false"
                @drop.prevent="handleDrop($event)"
              >
                <div class="space-y-4">
                  <div class="flex items-center justify-center w-20 h-20 mx-auto bg-yellow-100 rounded-full">
                    <i class="text-3xl text-yellow-600 fas fa-file-archive"></i>
                  </div>
                  <div>
                    <h3 class="mb-2 text-xl font-semibold text-gray-800">Drop files here or add them manually</h3>
                    <p class="mb-4 text-gray-500">You can drag and drop multiple files at once</p>
                    <button 
                      type="button" 
                      @click="addFile()"
                      class="inline-flex items-center px-6 py-3 font-semibold text-yellow-700 transition-all duration-200 border-2 border-yellow-500 rounded-xl hover:bg-yellow-50"
                    >
                      <i class="mr-2 fas fa-plus"></i>Add File
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <!-- File List -->
            <div x-show="files.length > 0" class="mb-8">
              <h3 class="mb-4 text-lg font-semibold text-gray-800">
                Selected Files (<span x-text="getValidFileCount()"></span>)
                <span x-show="getTotalSize() > 0" class="text-sm font-normal text-gray-500">
                  - Total: <span x-text="formatFileSize(getTotalSize())"></span>
                </span>
              </h3>
              
              <div class="space-y-3">
                <template x-for="(fileItem, index) in files" :key="fileItem.id">
                  <div class="p-4 border border-gray-200 rounded-xl bg-gray-50">
                    <div class="flex items-center justify-between">
                      <div class="flex-1 mr-4">
                        <input 
                          type="file" 
                          :name="'file[' + index + ']'"
                          @change="handleFileSelect($event, index)"
                          class="w-full text-sm text-gray-900 bg-white border border-gray-300 rounded-lg cursor-pointer focus:outline-none"
                        />
                        <div x-show="fileItem.file" class="mt-2 text-sm text-gray-600">
                          <span x-text="fileItem.name"></span>
                          <span class="ml-2 text-gray-400">(<span x-text="formatFileSize(fileItem.size)"></span>)</span>
                        </div>
                      </div>
                      <button 
                        type="button" 
                        @click="removeFile(index)"
                        class="p-2 text-red-500 transition-colors duration-200 rounded-lg hover:text-red-700 hover:bg-red-50"
                      >
                        <i class="fas fa-trash"></i>
                      </button>
                    </div>
                  </div>
                </template>
              </div>
            </div>

            <!-- Hidden input for file count -->
            <input type="hidden" name="length" x-bind:value="files.length" />

            <!-- Error Messages -->
            {% with messages = get_flashed_messages() %}
              {% if messages %}
                <div class="mb-6">
                  {% for message in messages %}
                    <div class="p-4 text-red-700 bg-red-100 border border-red-300 rounded-lg">
                      <p><i class="mr-2 fas fa-exclamation-triangle"></i>{{ message }}</p>
                    </div>
                  {% endfor %}
                </div>
              {% endif %}
            {% endwith %}

            <!-- Dynamic Error Message -->
            <div x-show="errorMessage" class="p-4 mb-6 text-red-700 bg-red-100 border border-red-300 rounded-lg">
              <p x-text="errorMessage"></p>
            </div>

            <!-- Create ZIP Button -->
            <div class="flex flex-col items-center space-y-4">
              <button 
                type="submit" 
                :disabled="getValidFileCount() === 0 || isProcessing"
                :class="getValidFileCount() > 0 && !isProcessing ? 'bg-gradient-to-r from-yellow-500 to-orange-600 hover:from-yellow-600 hover:to-orange-700 cursor-pointer' : 'bg-gray-400 cursor-not-allowed'"
                class="w-full px-8 py-4 text-lg font-semibold text-white transition-all duration-200 rounded-xl"
              >
                <span x-show="!isProcessing" class="flex items-center justify-center">
                  <i class="mr-2 fas fa-file-archive"></i>
                  Create ZIP Archive
                </span>
                <span x-show="isProcessing" class="flex items-center justify-center">
                  <i class="mr-2 fas fa-spinner fa-spin"></i>
                  Creating Archive...
                </span>
              </button>
              
              <p class="text-sm text-center text-gray-500">
                All selected files will be compressed into a single ZIP archive
              </p>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Loading Overlay -->
<div x-show="isProcessing" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50" style="display: none;">
  <div class="max-w-sm p-8 mx-4 text-center bg-white rounded-2xl">
    <div class="flex items-center justify-center w-16 h-16 mx-auto mb-4 bg-yellow-100 rounded-full">
      <i class="text-2xl text-yellow-600 fas fa-spinner fa-spin"></i>
    </div>
    <h3 class="mb-2 text-lg font-semibold text-gray-800">Creating ZIP Archive</h3>
    <p class="text-gray-600">Please wait while we compress your files...</p>
  </div>
</div>

{% endblock %}
